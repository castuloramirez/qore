#!/usr/bin/env qore
# -*- mode: qore; indent-tabs-mode: nil -*-

%new-style
%enable-all-warnings
%require-types
%strict-args

%requires ../../../../qlib/Util.qm
%requires ../../../../qlib/QUnit.qm

%exec-class ExceptionLocationTest

class ExceptionLocationTest inherits QUnit::Test {
    constructor() : QUnit::Test("Exception location test", "1.0") {
        addTestCase("Exception location test", \testExceptionLocation());
        set_return_value(main());
    }

    testExceptionLocation() {
        *int line;
        try {
            hash h = do_loc1();
            delete h;
        }
        catch (hash ex) {
            line = ex.line;
        }

        testAssertionValue("runtime-location-1", line, 23);

        {
            Program p();
            p.parse("namespace A {\nconst A = 1;\nclass B {}}\n", "A");
            hash ex = getEx(\p.parse(), "namespace A {\nconst A = 2;\n}", "B");
            assertEq(2, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: B>", ex.file);

            ex = getEx(\p.parse(), "const A::A\n= 2;\n", "C");
            assertEq(1, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: C>", ex.file);

            ex = getEx(\p.parse(), "class A\n{}\n", "D");
            assertEq(1, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: D>", ex.file);

            ex = getEx(\p.parse(), "class\n ::A {}", "E");
            assertEq(2, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: E>", ex.file);

            ex = getEx(\p.parse(), "namespace A {\nclass B {\n}\n}", "G");
            assertEq(2, ex.line);
            assertEq(3, ex.endline);
            assertEq("<run-time-loaded: G>", ex.file);

            ex = getEx(\p.parse(), "sub t() {code a = \\a.printf(1\n);\n}", "H");
            assertEq(1, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: H>", ex.file);

            ex = getEx(\p.parse(), "int i\n = 1;\n", "I");
            assertEq(1, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: I>", ex.file);

            ex = getEx(\p.parse(), "class B {\nconstructor() {\nX::a();}\n}", "J");
            assertEq(3, ex.line);
            assertEq(3, ex.endline);
            assertEq("<run-time-loaded: J>", ex.file);

            ex = getEx(\p.parse(), "class B inherits\nB {}\n", "J");
            assertEq(1, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: J>", ex.file);

            ex = getEx(\p.parse(), "class B1 inherits B {} class B inherits\nB1 {}\n", "K");
            assertEq(1, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: K>", ex.file);

            ex = getEx(\p.parse(), "class B1 {\n} class B inherits\nB1, private B1 {}\n", "L");
            assertEq(1, ex.line);
            assertEq(2, ex.endline);
            assertEq("<run-time-loaded: L>", ex.file);

            ex = getEx(\p.parse(), "class B1 {\n} class B inherits\nB1 {constructor() : B1(int i = \n2) {}}\n", "M");
            assertEq(3, ex.line);
            assertEq(4, ex.endline);
            assertEq("<run-time-loaded: M>", ex.file);

            ex = getEx(\p.parse(), "class B1 {\nfinal x() {}\n}\nclass B inherits B1 {x() {\n}\n}", "N");
            printf("%s\n", get_exception_string(ex));
            assertEq(4, ex.line);
            assertEq(4, ex.endline);
            assertEq("<run-time-loaded: N>", ex.file);
        }
    }

    static hash getEx(code c) {
        try {
            call_function_args(c, argv);
        }
        catch (hash ex) {
            return ex;
        }
        throw "GETEX-ERROR", "no exception thrown";
    }

    static *hash do_loc1() {
        return ExceptionLocationTest::do_loc1_1();
    }

    static *hash do_loc1_1() {
    }
}
