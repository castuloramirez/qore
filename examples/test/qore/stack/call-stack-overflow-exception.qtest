#!/usr/bin/env qore
%new-style

%require-types
%enable-all-warnings

%requires ../../../../qlib/QUnit.qm

%exec-class StackGuardTest

public class StackGuardTest inherits QUnit::Test {
    constructor() : Test("StackuardTest", "1.0") {
        testFunctions = (
            ("func": \testInfiniteRecurse(), "name": "Test overflowing the stack limit"),
            ("func": \testRecurseWithBackground(), "name": "Test two threads"),
        );
	set_return_value(main());
    }

    setUp() {
        if (!Option::HAVE_STACK_GUARD) {
            testSkip("Qore library was not built with stack protection support");
        }
    }

    recurse() {
        recurse();
    }

    testInfiniteRecurse() {
        testAssertion(\recurse(), list(), new QUnit::TestResultExceptionRegexp("STACK-LIMIT-EXCEEDED", "this thread's stack has exceeded the stack size limit"));
    }

    testRecurseWithBackground() {
        background testInfiniteRecurse();
        testInfiniteRecurse();
    }
}

